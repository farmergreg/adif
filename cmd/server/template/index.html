<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <title>ADI ‚ü∑ JSON Converter</title>
    <link rel="stylesheet" href="/static/pico-2.0.6.min.css">
</head>

<body>
    <main class="container">
        <article>
            <header>
                <h1>Convert ADIF &lt;==&gt; JSON</h1>
            </header>

            <section>
                <h3>API Endpoints</h3>
                <ul>
                    <li>POST JSON to <code>/api/v1/</code> with Content-Type <code>{{.ContentTypeJSON}}</code> to
                        convert to ADI.</li>
                    <li>POST an ADI document to <code>/api/v1/</code> with Content-Type <code>{{.ContentTypeADI}}</code>
                        to convert to JSON.</li>
                </ul>
            </section>
        </article>
        <article>
            <header>Try it out</header>
            <form id="conversion-form">
                <select name="conversion-type" id="conversion-type">
                    <option value="{{.ContentTypeADI}}">ADIF to JSON</option>
                    <option value="{{.ContentTypeJSON}}">JSON to ADIF</option>
                </select>
                <textarea name="input" placeholder="Enter ADIF or JSON here" style="min-height: 300px;"
                    aria-invalid="false" aria-describedby="input-helper">&lt;CALL:5&gt;w9pva&lt;EOR&gt;</textarea>
                <small id="input-helper" style="display: none;"></small>
                <button type="submit">Convert</button>
            </form>
        </article>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('conversion-form');
            const select = document.getElementById('conversion-type');
            const textarea = form.querySelector('textarea[name="input"]');
            const inputHelper = document.getElementById('input-helper');
            const button = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const input = textarea.value;
                const contentType = select.value;

                button.setAttribute('aria-busy', 'true');

                fetch('/api/v1/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': contentType
                    },
                    body: input
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        textarea.value = data;
                        textarea.setAttribute('aria-invalid', 'false');
                        inputHelper.textContent = 'Conversion successful!';
                        inputHelper.className = 'text-success';
                        inputHelper.style.display = 'block';

                        if (select.value === '{{.ContentTypeADI}}') {
                            select.value = '{{.ContentTypeJSON}}';
                        } else {
                            select.value = '{{.ContentTypeADI}}';
                        }
                    })
                    .catch(error => {
                        textarea.setAttribute('aria-invalid', 'true');
                        if (error.message.includes('HTTP error 400')) {
                            inputHelper.textContent = 'Conversion failed please check your input.';
                        } else {
                            inputHelper.textContent = `Server Error: ${error.message}`;
                        }
                        inputHelper.className = 'text-error';
                        inputHelper.style.display = 'block';
                    })
                    .finally(() => {
                        button.setAttribute('aria-busy', 'false');
                    });
            });

            textarea.addEventListener('input', function () {
                textarea.removeAttribute('aria-invalid');
                inputHelper.style.display = 'none';
            });
        });
    </script>
</body>

</html>